#!/bin/sh
# Pre-commit hook with automatic stash restoration on failure

# Don't exit on error immediately - we need to handle cleanup
set +e

# Colors for output
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
NC='\033[0m' # No Color

# Function to print error messages
error() {
  echo "${RED}âœ– $1${NC}" >&2
}

# Function to print warning messages
warning() {
  echo "${YELLOW}âš  $1${NC}" >&2
}

# Function to print info messages
info() {
  echo "${GREEN}â„¹ $1${NC}"
}

# Check for and remove git lock file if it exists
if [ -f .git/index.lock ]; then
  warning "Git lock file detected (.git/index.lock)"
  warning "Another git process may be running, or a previous process crashed"
  info "Removing lock file..."
  rm -f .git/index.lock
  warning "Lock file removed. If another git process is running, this may cause issues."
fi

# Function to find and restore lint-staged stash
restore_lint_staged_stash() {
  error ""
  error "lint-staged failed. Attempting to restore your changes..."
  
  # Find the most recent lint-staged stash
  # lint-staged creates stashes with messages like "lint-staged automatic backup"
  LINT_STAGED_STASH=$(git stash list --format="%h %s" | grep -i "lint-staged" | head -1 | cut -d' ' -f1)
  
  if [ -n "$LINT_STAGED_STASH" ]; then
    info "Found lint-staged stash: $LINT_STAGED_STASH"
    
    # Try to restore with --index first (preserves staging), then without
    if git stash pop --index "$LINT_STAGED_STASH" 2>/dev/null; then
      info "âœ“ Changes restored successfully (with staging preserved)"
    elif git stash pop "$LINT_STAGED_STASH" 2>/dev/null; then
      info "âœ“ Changes restored successfully"
      warning "Note: Staging information may have been lost"
    else
      error "Failed to automatically restore stash"
      warning "You can manually restore with:"
      warning "  git stash list"
      warning "  git stash apply $LINT_STAGED_STASH"
      return 1
    fi
    
    info "Your working directory is back to the state before the commit attempt"
    return 0
  else
    # Check if there's any stash at all (might be from a previous failed attempt)
    STASH_COUNT=$(git stash list | wc -l | tr -d ' ')
    if [ "$STASH_COUNT" -gt 0 ]; then
      warning "Found $STASH_COUNT stash(es), but none match lint-staged pattern"
      info "Latest stash:"
      git stash list -1
      warning "You may need to manually restore:"
      warning "  git stash list"
      warning "  git stash apply stash@{0}"
    else
      warning "No stash found to restore"
      warning "Your changes may not have been stashed, or were already restored"
    fi
    return 1
  fi
}

# Capture stash count before running lint-staged
STASH_COUNT_BEFORE=$(git stash list | wc -l | tr -d ' ')

# Run lint-staged
info "Running lint-staged..."
npx lint-staged
LINT_STAGED_EXIT_CODE=$?

# Check if lint-staged failed
if [ $LINT_STAGED_EXIT_CODE -ne 0 ]; then
  error ""
  error "Pre-commit checks failed. Commit aborted."
  error ""
  
  # Check if a new stash was created
  STASH_COUNT_AFTER=$(git stash list | wc -l | tr -d ' ')
  
  if [ "$STASH_COUNT_AFTER" -gt "$STASH_COUNT_BEFORE" ]; then
    # A new stash was created - restore it
    restore_lint_staged_stash
  else
    # No new stash, but lint-staged failed
    error "lint-staged failed, but no stash was created"
    error "Your changes should still be in your working directory"
    error "Check: git status"
  fi
  
  error ""
  error "Please fix the errors above and try again."
  exit 1
fi

# Run TypeScript type checking on staged files only
# This catches type errors that ESLint doesn't catch
echo ""
info "ðŸ” Running TypeScript type check on staged files..."

# Ensure we're using Node 20
if command -v nvm &> /dev/null; then
  source ~/.nvm/nvm.sh
  nvm use 20 || {
    error "Failed to switch to Node 20. Please install: nvm install 20"
    exit 1
  }
fi

# Get staged TypeScript files
STAGED_TS_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx)$' || true)

if [ -z "$STAGED_TS_FILES" ]; then
  info "âœ“ No TypeScript files staged, skipping type check"
else
  # Count files for display (handle both single and multiple files)
  FILE_COUNT=$(echo "$STAGED_TS_FILES" | wc -l | tr -d ' ')
  info "Checking $FILE_COUNT staged TypeScript file(s)..."
  
  # Run TypeScript check on the whole project
  # This ensures proper path alias resolution and JSX recognition
  # TypeScript will check all files but we can filter output to staged files if needed
  if yarn tsc --noEmit --project tsconfig.json 2>&1; then
    info "âœ“ Type checking passed"
  else
    TSC_EXIT=$?
    error ""
    error "TypeScript type checking failed."
    error "ðŸ’¡ Fix the type errors above and try again."
    error ""
    exit 1
  fi
fi

# Success
info "âœ“ Pre-commit checks passed"
exit 0
